
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>新增卡片</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h2>新增會員卡</h2>
    <label for="presetSelect">常見卡片</label>
    <select id="presetSelect"><option value="">請選擇</option></select>
    <label for="name">卡片名稱</label>
    <input type="text" id="name" />
    <label for="icon">圖示網址</label>
    <input type="url" id="icon" />
    <label for="barcode">條碼內容</label>
    <input type="text" id="barcode" />
    <button id="scanBtn">📷 掃描條碼</button> <button id="saveBtn">💾 儲存卡片</button>
    <div id="scanner" style="width:100%;max-width:400px;height:300px;"></div>
    
  </main>
  <nav class="bottom-nav">
    <a href="index.html">首頁</a>
    <a href="add.html" class="active">新增</a>
    <a href="settings.html">設定</a>
  </nav>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // 初始化 IndexedDB
    const dbName = 'membershipCards';
    let db;
    const openRequest = indexedDB.open(dbName, 1);

    openRequest.onupgradeneeded = (e) => {
      db = e.target.result;
      const store = db.createObjectStore('cards', { keyPath: 'id', autoIncrement: true });
      store.createIndex('name', 'name', { unique: false });
    };

    openRequest.onsuccess = (e) => {
      db = e.target.result;
    };

    // 儲存卡片至 IndexedDB
    const saveCardToDB = (card) => {
      const transaction = db.transaction(['cards'], 'readwrite');
      const store = transaction.objectStore('cards');
      store.add(card);
      transaction.oncomplete = () => {
        alert('卡片已儲存');
      };
      transaction.onerror = () => {
        alert('儲存失敗');
      };
    };

    // 條碼掃描功能
	const codeReader = new ZXing.BrowserMultiFormatReader();
    document.getElementById("scanBtn").addEventListener("click", () => {
      const preview = document.getElementById("scanner");
      codeReader.decodeFromVideoDevice(null, preview, (result, err) => {
        if (result) {
          document.getElementById("barcode").value = result.getText();
          codeReader.reset();
          preview.innerHTML = ""; // 清除攝影畫面
          alert("掃描成功：" + result.getText());
        }
      });
    });
	
	// 匯入預設卡片清單
    fetch('preset-cards.json')
      .then(res => res.json())
      .then(cards => {
        const select = document.getElementById("presetSelect");
        cards.forEach(card => {
          const option = document.createElement("option");
          option.value = card.name;
          option.textContent = card.name;
          option.dataset.icon = card.icon;
          select.appendChild(option);
        });
        select.addEventListener("change", () => {
          const selected = select.options[select.selectedIndex];
          document.getElementById("name").value = selected.value;
          document.getElementById("icon").value = selected.dataset.icon || "";
        });
      });
	  
	// 儲存按鈕事件
    document.getElementById("saveBtn").addEventListener("click", () => {
      const name = document.getElementById("name").value;
      const icon = document.getElementById("icon").value;
      const barcode = document.getElementById("barcode").value;

      if (name && barcode) {
        const card = { name, icon, barcode };
        saveCardToDB(card);
      } else {
        alert("請輸入完整資料！");
      }
    });
  </script>
  <script src="index.js"></script>
</body>
</html>
