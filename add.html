
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ–°å¢å¡ç‰‡</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h2>æ–°å¢æœƒå“¡å¡</h2>
    <label for="presetSelect">å¸¸è¦‹å¡ç‰‡</label>
    <select id="presetSelect"><option value="">è«‹é¸æ“‡</option></select>
    <label for="name">å¡ç‰‡åç¨±</label>
    <input type="text" id="name" />
    <label for="icon">åœ–ç¤ºç¶²å€</label>
    <input type="url" id="icon" />
    <label for="barcode">æ¢ç¢¼å…§å®¹</label>
    <input type="text" id="barcode" />
    <button id="scanBtn">ğŸ“· æƒææ¢ç¢¼</button> <button id="saveBtn">ğŸ’¾ å„²å­˜å¡ç‰‡</button>
    <div id="scanner" style="width:100%;max-width:400px;height:300px;"></div>
    
  </main>
  <nav class="bottom-nav">
    <a href="index.html">é¦–é </a>
    <a href="add.html" class="active">æ–°å¢</a>
    <a href="settings.html">è¨­å®š</a>
  </nav>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    // åˆå§‹åŒ– IndexedDB
    const dbName = 'membershipCards';
    let db;
    const openRequest = indexedDB.open(dbName, 1);

    openRequest.onupgradeneeded = (e) => {
      db = e.target.result;
      const store = db.createObjectStore('cards', { keyPath: 'id', autoIncrement: true });
      store.createIndex('name', 'name', { unique: false });
    };

    openRequest.onsuccess = (e) => {
      db = e.target.result;
    };

    // å„²å­˜å¡ç‰‡è‡³ IndexedDB
    const saveCardToDB = (card) => {
      const transaction = db.transaction(['cards'], 'readwrite');
      const store = transaction.objectStore('cards');
      store.add(card);
      transaction.oncomplete = () => {
        alert('å¡ç‰‡å·²å„²å­˜');
      };
      transaction.onerror = () => {
        alert('å„²å­˜å¤±æ•—');
      };
    };

    // æ¢ç¢¼æƒæåŠŸèƒ½
	const codeReader = new ZXing.BrowserMultiFormatReader();
    document.getElementById("scanBtn").addEventListener("click", () => {
      const preview = document.getElementById("scanner");
      codeReader.decodeFromVideoDevice(null, preview, (result, err) => {
        if (result) {
          document.getElementById("barcode").value = result.getText();
          codeReader.reset();
          preview.innerHTML = ""; // æ¸…é™¤æ”å½±ç•«é¢
          alert("æƒææˆåŠŸï¼š" + result.getText());
        }
      });
    });
	
	// åŒ¯å…¥é è¨­å¡ç‰‡æ¸…å–®
    fetch('preset-cards.json')
      .then(res => res.json())
      .then(cards => {
        const select = document.getElementById("presetSelect");
        cards.forEach(card => {
          const option = document.createElement("option");
          option.value = card.name;
          option.textContent = card.name;
          option.dataset.icon = card.icon;
          select.appendChild(option);
        });
        select.addEventListener("change", () => {
          const selected = select.options[select.selectedIndex];
          document.getElementById("name").value = selected.value;
          document.getElementById("icon").value = selected.dataset.icon || "";
        });
      });
	  
	// å„²å­˜æŒ‰éˆ•äº‹ä»¶
    document.getElementById("saveBtn").addEventListener("click", () => {
      const name = document.getElementById("name").value;
      const icon = document.getElementById("icon").value;
      const barcode = document.getElementById("barcode").value;

      if (name && barcode) {
        const card = { name, icon, barcode };
        saveCardToDB(card);
      } else {
        alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ï¼");
      }
    });
  </script>
  <script src="index.js"></script>
</body>
</html>
